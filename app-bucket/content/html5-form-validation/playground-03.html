<style>

    .pseudo-form {
        margin-top: 2rem;
        padding: 1rem 0.5rem;
        zoom: 1.2;
    }


    #console-log-header{
        background-color: whitesmoke;
        border: 4px solid bisque;
        border-bottom: none;
        width: 18rem;
        margin-top: 1.1rem;
        padding: 0.2rem 0.4rem;
    }
    #console-log{
        background-color: bisque;
        margin: 1.5rem 0;
        margin-top: 0;

        position: relative;
        display: block ;

        border: none;
    }


    p {
        margin-bottom: 0.3rem;
        line-height: 110%;

        padding: 0.6rem 0;


    }


    .block {
        display: inline-block;
        margin: 0.5rem 0;
        margin-right: 2rem;
        margin-right: 1rem;
    }

    .tab {
        display: inline-block;
        width: 4rem;
    }

    label {
        min-width: 10rem;
        text-align: right;
        aaborder: 1px solid greenyellow;
        display: inline-block;
    }
    .control {
        display: inline-block;
        margin-right: 2rem;
    }
    .control:last-child {
        margin-right: 0rem;
    }


    @media screen and (min-width: 800px) {
        .block-wide {
            min-width: 90%;
        }
        label {
            min-width:  5rem;
        }

    }



</style>


<div class="pseudo-form">


    <!-- <p>GDP will...</p> -->

    <div class="block">

        <label for="y_probgood">
            GDP will improve
        </label>

        <div class="control">

            <input type="number" name="y_probgood" id="y_probgood"
            min="0"
            max="100"
            step="1"
            data-validation_msg="Please enter a number between 0 and 100"
            > %
        </div>

    </div>

    <div class="block">

        <label for="y_probnormal">
            remain  <br> same
        </label>

        <div class="control">

            <input type="number" name="y_probnormal" id="y_probnormal"
            min="0"
            max="100"
            step="1"
            data-validation_msg="Please enter a number between 0 and 100"
            value="-2"
            > %
        </div>

    </div>


    <div class="block">

        <label for="y_probbad">
            deteri<br>orate
        </label>

        <div class="control">

            <input type="number" name="y_probbad" id="y_probbad"
            min="0"
            max="100"
            step="1"
            data-validation_msg="Please enter a number between 0 and 100"
            > %
        </div>

    </div>

    <hr>


    <div class="block block-wide">

        <label for="dax_erw">
            DAX expected
        </label>

        <div class="control">

            <input type="number" name="dax_erw" id="dax_erw"
            min="2000"
            max="25000"
            step="1"
            data-validation_msg="Please enter a number between 2.000 and 25.000"
            value="14.5"
            >
        </div>

    </div>

    <div class="block">

        <label for="dax_min">
            DAX Min
        </label>


        <div class="control">
            <input type="number" name="dax_min" id="dax_min"
                min="2000"
                max="25000"
                step="1"
                data-validation_msg="Please enter a number between 2.000 and 25.000"
                xxvalue=16000
            >
        </div>
    </div>


    <div class="block">

        <label for="dax_max">
            DAX Max
        </label>

        <div class="control">
            <input type="number" name="dax_max" id="dax_max"
                min="2000"
                max="25000"
                step="1"
                data-validation_msg="Please enter a number between 2.000 and 25.000"
                xxvalue=12000
            >
        </div>
    </div>

    <br>

    <input  type="submit"  name="submitBtn1"  value="Input type submit" title="input[type=submit]"  accesskey="s">
    <input  type="reset"   name="resetBtn1"   value="Reset" >


</div><!-- /pseudo-form -->


    <hr>

    <h3>Validation options</h3>

    <p>
        Default:  &nbsp; Popups with nerdy wording and in browser language
        on submit
    </p>


    <p>
        <input type="checkbox" id="validateFormWithCustomBubbles" accesskey="f">
        Custom popups for invalids on <u>f</u>orm submit
    </p>

    <p>
        <input type="checkbox" id="showBubbleOnBlurOrInput">
        Custom popups for invalids already on blur
    </p>



    <p style="margin-left: 2rem; margin-top: 0.2rem">

        Custom popups even on each keyboard input
        <br>
        <span class="tab"></span>

        <input type="radio"  name="onInput"  value="neither"        >
        none

        <span class="tab"></span>

        <input type="radio"  name="onInput"  value="onInputRemove"        >
        remove

        <span class="tab"></span>

        <input type="radio"  name="onInput"  value="onInputShowAndRemove" >
        raise & remove

        <span class="tab"></span>


        <input type="checkbox" id="lockFocus">
        lock

    </p>


    <p>
        <input type="checkbox" id="onlyOneBubble">
        Only a single bubble at a time - focus induced
    </p>



    <p style="margin-left: 2rem; margin-top: 0.2rem">
        Compound validation

        <span class="tab"></span>

        <input type="checkbox" id="compoundOnSubmit"> on submit

        <span class="tab"></span>

        <input type="checkbox" id="compoundOnBlur"> on blur
    </p>








<!--


    <a class="link-as-button"
    href="#"
    onclick="configure();"
    accesskey="s"
    >Configure</a>
-->




    <div id=console-log-header>console log - inversely ordered</div>
    <div id="console-log"></div>




<script>


    var logFn = console.log;  // save the original log function for later use
    var myLog = document.getElementById("console-log");
    console.log = function () {
        var line = "";
        for (var i = 0, j = arguments.length; i < j; i++) {
            if (typeof arguments[i] == "object") {
                // var argX = arguments[i];
                // var tp   = typeof argX;
                // var content = JSON.stringify(argX);
                // line += " " + tp + " " + content;
                line += " " + arguments[i];
                logFn.call(console, arguments[i]);
            } else {
                line += " " + arguments[i];
            }
        }
        if (line.length > 0) {
            myLog.innerHTML = line + "<br>" + myLog.innerHTML ;
            logFn.call(console, line); // call original function if you want to
        }
    };


    // load config from local browser storage 
    // setting the UI elements
    function loadConfigIntoUI(){
        for (let i = 0; i < configControls.length; i++) {
            let inpName = configControls[i];
            var storedVal = window.localStorage.getItem(inpName);

            if (inpName == "onInput") {
                if (storedVal === null) {
                    storedVal = "neither"
                }
                let options = document.getElementsByName(inpName);
                for (let i = 0; i < options.length; i++) {
                    let radio = options[i];
                    if (radio.value == storedVal) {
                        radio.checked = true;
                    }
                }
                continue;
            }

            // console.log(`${chkName} was checked ${wasChecked} type ${typeof wasChecked}`);
            if (storedVal === "true") {
                document.getElementById(inpName).checked = storedVal;
            }

            // default
            if (storedVal === null) {
                // to true
                if (inpName == "showBubbleOnBlurOrInput") {
                    document.getElementById(inpName).checked = true;
                }
                if (inpName == "onlyOneBubble") {
                    document.getElementById(inpName).checked = true;
                }

            }
        }

    }

    // save config to local browser storage 
    function saveConfig(){
        for (let i = 0; i < configControls.length; i++) {
            let inpName = configControls[i];

            if (inpName == "onInput") {
                let options = document.getElementsByName(inpName);
                for (let i = 0; i < options.length; i++) {
                    let radio = options[i];
                    if (radio.checked) {
                        window.localStorage.setItem(inpName, radio.value);
                    }
                }
                continue
            }

            var chk = document.getElementById(inpName);
            window.localStorage.setItem(inpName, chk.checked);
        }
    }



    // reset form and input[type=number]
    // not resetting the config UI handlers
    function resetNonConfigUIListeners(form){

        form.oninvalid  = null;
        form.onvalid    = null;
        form.onsubmit   = null;

        var inputs = form.querySelectorAll("input[type=number]");
        for (var i = 0; i < inputs.length; i++) {
            var inp = inputs[i];
            inp.onvalid    = null;
            inp.onblur     = null;
            inp.onfocus    = null;
            inp.oninput    = null;
        }

    }


    //
    // compound validity computation 
    // without any user interface
    
    function mustAddUp100() {

        var inp1 = document.forms.frmMain.y_probgood.value;
        var inp2 = document.forms.frmMain.y_probnormal.value;
        var inp3 = document.forms.frmMain.y_probbad.value;
        // console.log("inp1-3: ", inp1, inp2, inp3);

        var i1 = 0
        if (inp1 != "") {
            var i1 = parseInt(inp1, 10);
        }
        var i2 = 0
        if (inp2 != "") {
            var i2 = parseInt(inp2, 10);
        }
        var i3 = 0
        if (inp3 != "") {
            var i3 = parseInt(inp3, 10);
        }
        // console.log("inp1-3 integer: ", i1, i2, i3);

        var sum = i1 + i2 + i3;
        // console.log("sum", sum);


        var suspicious = 0;

        if (inp1 != "" && inp2 != "" && inp3 != "") {
            if (sum != 100) {
                suspicious = 1;
            }
        }

        return suspicious;

    }


    function daxForecastInbetween() {

        var inp1 = document.forms.frmMain.dax_erw.value;
        var inp2 = document.forms.frmMain.dax_min.value;
        var inp3 = document.forms.frmMain.dax_max.value;
        // console.log("inp1-3: ", inp1, inp2, inp3);

        var i1 = 0
        if (inp1 != "") {
            var i1 = parseInt(inp1, 10);
        }
        var i2 = 0
        if (inp2 != "") {
            var i2 = parseInt(inp2, 10);
        }
        var i3 = 0
        if (inp3 != "") {
            var i3 = parseInt(inp3, 10);
        }
        // console.log("inp1-3 integer: ", i1, i2, i3);

        var suspicious = 0;

        // min < max?
        if (inp2 != "" && inp3 != "" && i2 > i3) {
            suspicious = 1;
            return suspicious;
        }


        // expectation between extremes?
        if (inp1 != "" && inp2 != "" && inp3 != "") {
            if (inp2 != "" && i1 < i2) {
                suspicious = 2;
            }

            if (inp3 != "" && i1 > i3) {
                suspicious = 2;
            }
        }

        return suspicious;

    }

    //
    // compound validation
    // event handlers
    // showing custom popups

    function mustAddUp100Bubble(event) {
        var err = mustAddUp100();
        if (err > 0) {
            console.log("mustAddUp100()", err);
            if (err == 1) {
                var e1 = document.forms.frmMain.y_probgood;
                var e2 = document.forms.frmMain.y_probnormal;
                var e3 = document.forms.frmMain.y_probbad;
                vd.ShowBubble(e1, "Does not add up to 100", true);
                vd.ShowBubble(e2, "Does not add up to 100", true);
                vd.ShowBubble(e3, "Does not add up to 100", true);
            }
            if (event.type == "submit") {
                // e1.focus();
            }
            event.preventDefault();
        }
    }

    function daxForecastBubble(event) {
        var err = daxForecastInbetween();
        if (err > 0) {
            console.log("daxForecastInbetween()", err);
            if (err == 1) {
                var e1 = document.forms.frmMain.dax_min;
                var e2 = document.forms.frmMain.dax_max;
                vd.ShowBubble(e1, "Please adjust Min and Max", true);
                vd.ShowBubble(e2, "Please adjust Min and Max", true);
                if (event.type == "submit") {
                    // e2.focus();
                }
            }
            if (err == 2) {
                var e1 = document.forms.frmMain.dax_erw;
                vd.ShowBubble(e1, "Please adjust expected DAX between Min and Max", true);
                if (event.type == "submit") {
                    // e1.focus();
                }
            }
            event.preventDefault();
        }
    }


    /* ============ UI for config ================  */


    var myForm = document.forms["frmMain"];
    var vd = new Validator(myForm);


    var configControls = [
        "onInput",
        "lockFocus",
        "validateFormWithCustomBubbles",
        "showBubbleOnBlurOrInput",
        "onlyOneBubble",
        "compoundOnSubmit",
        "compoundOnBlur",
    ];


    // change handlers for config checkboxes
    function  validateFormWithCustomBubblesExec() {
        let nameCheck = "validateFormWithCustomBubbles"
        let checkbox = document.getElementById(nameCheck);
        if (checkbox.checked) {
            vd.validateFormWithCustomBubbles();
        }
    }

    function  showBubbleOnBlurOrInputExec() {
        let nameCheck = "showBubbleOnBlurOrInput"
        let checkbox = document.getElementById(nameCheck);
        if (checkbox.checked) {
            vd.showBubbleOnBlurOrInput();
            // console.log(`checkbox ${nameCheck} executed`)
        }
    }

    function onInputExec() {
        let inpName = "onInput"
        let options = document.getElementsByName(inpName);
        for (let i = 0; i < options.length; i++) {
            let radio = options[i];
            if (radio.checked) {
                if (radio.value == "onInputRemove") {
                    vd.SetOnInputRemove(true);
                    vd.SetOnInputShowAndRemove(false);
                } else if (radio.value == "onInputShowAndRemove") {
                    vd.SetOnInputRemove(false);
                    vd.SetOnInputShowAndRemove(true);
                } else if (radio.value == "neither") {
                    vd.SetOnInputRemove(false);
                    vd.SetOnInputShowAndRemove(false);
                }
            }
        }
    }

    function lockFocusExec() {
        let nameCheck = "lockFocus"
        let checkbox = document.getElementById(nameCheck);
        if (checkbox.checked) {
            vd.SetLockFocus(true);
        } else {
            vd.SetLockFocus(false);
        }
    }

    function  onlyOneBubbleExec() {
        let nameCheck = "onlyOneBubble"
        let checkbox = document.getElementById(nameCheck);
        if (checkbox.checked) {
            vd.SetOnlyOneBubble(true);
        } else {
            vd.SetOnlyOneBubble(false);
        }
    }

    // configure compound validation

    var compoundOnSubmit = false;
    function  compoundOnSubmitExec() {
        let nameCheck = "compoundOnSubmit"
        let checkbox = document.getElementById(nameCheck);
        if (checkbox.checked) {
            compoundOnSubmit = true;
        } else {
            compoundOnSubmit = false;
        }
    }

    var compoundOnBlur = false;
    function  compoundOnBlurExec() {
        let nameCheck = "compoundOnBlur"
        let checkbox = document.getElementById(nameCheck);
        if (checkbox.checked) {
            compoundOnBlur = true;
        } else {
            compoundOnBlur = false;
        }
    }






    // function configure resets all event handlers
    // it re-registers all event handlers,
    // according to config UI parameters
    function configure(initial){

        if (initial !== undefined) {
            loadConfigIntoUI();            
        }

        resetNonConfigUIListeners(myForm);

        // configure validator according to UI settings

          onInputExec();
          lockFocusExec();
        validateFormWithCustomBubblesExec();
        showBubbleOnBlurOrInputExec();
        onlyOneBubbleExec();

        compoundOnSubmitExec();
        compoundOnBlurExec();


        saveConfig();
        
        // re-register event handlers
        // for compound validation
        // depending on UI config settings
        if (compoundOnSubmit) {
            myForm.addEventListener(
                "submit",
                mustAddUp100Bubble,
                false
            );

            myForm.addEventListener(
                "submit",
                daxForecastBubble,
                false
            );
            // console.log("compound validation on submit: true");
        } else {
            // console.log("compound validation on submit: false");
        }

        if (compoundOnBlur) {
            var daxInputs = [
                "dax_erw",
                "dax_min",
                "dax_max",
            ];

            for (var inp of daxInputs) {
                myForm.elements[inp].addEventListener(
                    'blur',
                    daxForecastBubble,
                    false,
                );
            }

            var yProbInputs = [
                "y_probgood",
                "y_probnormal",
                "y_probbad",
            ];

            for (var inp of yProbInputs) {
                myForm.elements[inp].addEventListener(
                    'blur',
                    mustAddUp100Bubble,
                    false,
                );
            }

            // console.log("compound validation on blur: true");
        } else {
            // console.log("compound validation on blur: false");
        }

        
        console.log("validation configured");
    }



    // on form load
    // initial configure()
    // assigning event handlers to config UI controls
    //   those are exempt from resetNonConfigUIListeners()
    document.addEventListener(
        'DOMContentLoaded',
        function () {

            myForm.method = "GET";
            myForm.action = "/{{AppPrefix}}/doc/html5-form-validation/playground-03.html";

            configure(true);

            var checkboxes = document.querySelectorAll('input[type=checkbox]');
            for (var checkbox of checkboxes) {
                checkbox.addEventListener('change', function (event) {
                    if (event.target.checked) {
                    }
                    configure();
                });
            }

            var radios = document.querySelectorAll('input[type=radio]');
            for (var radio of radios) {
                radio.addEventListener('change', function (event) {
                    if (event.target.checked) {
                        configure();
                    }
                });
            }


        },
        false
    );





</script>



